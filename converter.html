<!DOCTYPE html>
<html lang="ar" dir="rtl" id="html-root">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محول الصوت - FCP Audio to XML</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&family=Cairo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Default Settings System -->
    <script src="default-settings.js"></script>
    <style>
        :root {
            --primary-color: #3b82f6;
            --secondary-color: #1e40af;
            --accent-color: #06b6d4;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --dark-bg: #0f172a;
            --card-bg: #1e293b;
            --surface-color: #334155;
            --border-color: #475569;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --gradient-primary: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            --gradient-secondary: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.2);
            --radius: 12px;
            --font-primary: 'Cairo', 'Inter', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            background: var(--dark-bg);
            color: var(--text-primary);
            line-height: 1.6;
            padding-top: 80px;
        }

        /* Navigation */
        .navbar {
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 1rem 0;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 2rem;
        }

        .nav-links a {
            color: var(--text-secondary);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            padding: 0.5rem 1rem;
            border-radius: 8px;
        }

        .nav-links a:hover {
            color: var(--accent-color);
            background: rgba(6, 182, 212, 0.1);
        }

        .nav-links a.active {
            color: var(--primary-color);
            background: rgba(59, 130, 246, 0.1);
        }

        /* Main Container */
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
        }

        .page-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .page-header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .page-header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .card-header {
            background: var(--surface-color);
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .card-header h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .card-header i {
            color: var(--accent-color);
            font-size: 1.5rem;
        }

        .card-body {
            padding: 2rem;
        }

        /* Upload Zone */
        .upload-zone {
            border: 3px dashed var(--border-color);
            border-radius: var(--radius);
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(6, 182, 212, 0.05) 100%);
            position: relative;
            overflow: hidden;
        }

        .upload-zone::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.6s ease;
        }

        .upload-zone:hover::before {
            left: 100%;
        }

        .upload-zone:hover {
            border-color: var(--accent-color);
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(6, 182, 212, 0.1) 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
        }

        .upload-zone.dragover {
            border-color: var(--success-color);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(34, 197, 94, 0.1) 100%);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4rem;
            color: var(--accent-color);
            margin-bottom: 1rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .upload-zone h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .upload-zone p {
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .file-input {
            display: none;
        }

        /* Audio Preview */
        .audio-preview {
            background: var(--surface-color);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-top: 1.5rem;
            border: 1px solid var(--border-color);
            display: none;
        }

        .audio-preview audio {
            width: 100%;
            margin-bottom: 1rem;
        }

        .audio-info {
            font-family: var(--font-mono);
            font-size: 0.9rem;
            color: var(--text-secondary);
            background: rgba(0,0,0,0.3);
            padding: 1rem;
            border-radius: 8px;
        }

        /* Form Groups */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            transition: all 0.3s ease;
            font-family: var(--font-primary);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 120px;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            font-size: 1rem;
            font-family: var(--font-primary);
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-lg);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(59, 130, 246, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #34d399);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(16, 185, 129, 0.3);
        }

        .btn-large {
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 700;
            min-height: 60px;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .action-buttons {
            text-align: center;
            margin-top: 3rem;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            color: white;
            font-weight: 600;
            z-index: 10000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
        }

        .notification.success {
            background: linear-gradient(135deg, var(--success-color), #34d399);
        }

        .notification.error {
            background: linear-gradient(135deg, var(--error-color), #f87171);
        }

        .notification.warning {
            background: linear-gradient(135deg, var(--warning-color), #fbbf24);
        }

        .notification.show {
            transform: translateX(0);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }
            
            .language-toggle {
                margin-left: auto;
            }

            .container {
                padding: 1rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .page-header h1 {
                font-size: 2rem;
            }

            .upload-zone {
                padding: 2rem 1rem;
            }

            .upload-icon {
                font-size: 3rem;
            }
            
            .lang-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
        }

        @media (max-width: 480px) {
            .nav-container {
                padding: 0 1rem;
            }
            
            .language-toggle {
                padding: 0.2rem;
            }
            
            .lang-btn {
                padding: 0.3rem 0.6rem;
                font-size: 0.75rem;
            }
            
            .page-header h1 {
                font-size: 1.75rem;
            }
            
            .btn-large {
                padding: 0.8rem 1.5rem;
                font-size: 1rem;
            }
        }

        /* RTL Support */
        [dir="rtl"] .nav-links {
            direction: ltr;
        }

        [dir="rtl"] .nav-container {
            flex-direction: row-reverse;
        }

        /* Language Toggle */
        .language-toggle {
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--surface-color);
            border-radius: 50px;
            padding: 0.3rem;
            border: 1px solid var(--border-color);
        }

        .lang-btn {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-family: var(--font-primary);
        }

        .lang-btn.active {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .lang-btn:hover:not(.active) {
            color: var(--accent-color);
            background: rgba(6, 182, 212, 0.1);
        }

        /* Enhanced Animations */
        @keyframes slideInFromRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideInFromLeft {
            from {
                transform: translateX(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeInUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .animate-slide-in {
            animation: slideInFromRight 0.6s ease-out;
        }

        [dir="ltr"] .animate-slide-in {
            animation: slideInFromLeft 0.6s ease-out;
        }

        .animate-fade-up {
            animation: fadeInUp 0.8s ease-out;
        }

        /* Language Transition */
        .transitioning {
            transition: all 0.5s ease-in-out;
        }

        /* Enhanced Cards */
        .card {
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 2px;
            background: var(--gradient-primary);
            transition: left 0.3s ease;
        }

        .card:hover::before {
            left: 0;
        }

        /* Enhanced Upload Zone */
        .upload-zone {
            position: relative;
            overflow: hidden;
        }

        .upload-zone::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            animation: rotate 4s linear infinite;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .upload-zone:hover::after {
            opacity: 1;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Modern Button Styles */
        .btn {
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        /* Loading States */
        .loading {
            position: relative;
            pointer-events: none;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Enhanced Notifications */
        .notification {
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .notification::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: rgba(255,255,255,0.3);
            animation: progress 3s linear;
        }

        @keyframes progress {
            from { width: 100%; }
            to { width: 0%; }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-film"></i> <span id="logo-text">محول صوت FCP</span>
            </div>
            <ul class="nav-links">
                <li><a href="index.html" id="nav-home">الرئيسية</a></li>
                <li><a href="converter.html" class="active" id="nav-converter">المحول</a></li>
                <li><a href="settings.html" id="nav-settings">الإعدادات</a></li>
                <li><a href="video-library.html" id="nav-library">مكتبة الفيديو</a></li>
            </ul>
            <div class="language-toggle">
                <button class="lang-btn active" onclick="switchLanguage('ar')" id="btn-arabic">العربية</button>
                <button class="lang-btn" onclick="switchLanguage('en')" id="btn-english">English</button>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container">
        <div class="page-header animate-fade-up">
            <h1 id="main-title">محول الصوت إلى XML</h1>
            <p id="main-subtitle">ارفع ملف الصوت وأدخل النصوص لإنشاء مشروع Final Cut Pro</p>
        </div>

        <!-- Media Upload Section -->
        <div class="card animate-slide-in">
            <div class="card-header">
                <i class="fas fa-music"></i>
                <h3 id="upload-title">رفع الملف الصوتي</h3>
            </div>
            <div class="card-body">
                <div class="upload-zone" onclick="document.getElementById('audioInput').click()">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h3 id="upload-main-text">رفع ملف صوتي أو فيديو</h3>
                    <p id="upload-support-text">يدعم: MP3, WAV, M4A, AAC, FLAC, OGG, MP4, MOV, AVI</p>
                    <p id="upload-instruction-text">اسحب وأفلت أو اضغط للاختيار</p>
                    <input type="file" id="audioInput" class="file-input" accept=".mp3,.wav,.m4a,.aac,.flac,.ogg,.mp4,.mov,.avi" onchange="handleAudioUpload(event)">
                </div>
                
                <div id="audioPreview" class="audio-preview">
                    <audio controls id="audioPlayer">
                        متصفحك لا يدعم عرض الملفات الصوتية.
                    </audio>
                    <div id="audioInfo" class="audio-info"></div>
                </div>

                <!-- Video Library Integration -->
                <div style="margin-top: 1rem; text-align: center;">
                    <button class="btn btn-primary" onclick="loadFromVideoLibrary()">
                        <i class="fas fa-video"></i> <span id="library-btn-text">تحميل من مكتبة الفيديو</span>
                    </button>
                    <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem;" id="library-description">
                        اختر من الفيديوهات المرفوعة مسبقاً
                    </p>
                </div>
            </div>
        </div>

        <!-- Text Content Section -->
        <div class="card animate-slide-in" style="animation-delay: 0.2s;">
            <div class="card-header">
                <i class="fas fa-keyboard"></i>
                <h3 id="text-content-title">محتوى النص</h3>
            </div>
            <div class="card-body">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" id="arabic-text-label">النص العربي الأساسي:</label>
                        <textarea id="arabicText" class="form-control" placeholder="" style="direction: rtl; text-align: right;"></textarea>
                        <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem;" id="arabic-text-description">
                            النص الرئيسي الذي سيظهر في الترجمة
                        </p>
                    </div>

                    <div class="form-group">
                        <label class="form-label" id="repetitive-text-label">المستهل (النص المتكرر):</label>
                        <textarea id="repetitiveText" class="form-control" placeholder="" style="direction: rtl; text-align: right;"></textarea>
                        <p style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.5rem;" id="repetitive-text-description">
                            النص الذي سيتم تكراره في المقطع (مثل: يا حسين، لبيك يا حسين، إلخ)
                        </p>
                    </div>

                    <!-- Poetry Processing Settings -->
                    <div class="form-group" style="background: rgba(59, 130, 246, 0.1); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <i class="fas fa-filter" style="color: var(--primary-color);"></i>
                            <label class="form-label" style="margin: 0;" id="poetry-filter-label">تنقية نصوص القصائد:</label>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem;">
                                <input type="checkbox" id="skipPoetryIntros" checked style="margin: 0;">
                                <span id="skip-intros-text">تجاهل المستهلات</span>
                            </label>
                            <span style="font-size: 0.8rem; color: var(--text-muted);" id="poetry-filter-description">
                                سيتم تجاهل العبارات الافتتاحية والختامية في القصائد
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- XML Output Section -->
        <div class="card animate-slide-in" style="animation-delay: 0.3s; display: none;" id="xmlSection">
            <div class="card-header">
                <i class="fas fa-check-circle" style="color: var(--success-color);"></i>
                <h3 id="xml-title">تم إنشاء ملف XML بنجاح!</h3>
            </div>
            <div class="card-body">
                <div class="success-message" style="text-align: center; margin-bottom: 2rem;">
                    <div style="font-size: 4rem; color: var(--success-color); margin-bottom: 1rem;">
                        <i class="fas fa-file-download"></i>
                    </div>
                    <h4 style="margin-bottom: 0.5rem; color: var(--text-primary);" id="success-title">ملف Final Cut Pro جاهز للتحميل</h4>
                    <p style="color: var(--text-secondary);" id="success-description">سيتم تحميل الملف تلقائياً، أو يمكنك الضغط على زر التحميل أدناه</p>
                </div>
                
                <div class="download-actions" style="text-align: center; margin-bottom: 2rem;">
                    <button class="btn btn-success btn-large" onclick="downloadXML()" id="downloadBtn">
                        <i class="fas fa-download"></i> <span id="download-btn-text">تحميل ملف XML</span>
                    </button>
                </div>

                <!-- Instructions Section -->
                <div class="instructions-container" style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(6, 182, 212, 0.1)); border-radius: 12px; padding: 2rem; border: 1px solid var(--border-color);">
                    <h4 style="margin-bottom: 1.5rem; color: var(--text-primary); text-align: center;" id="instructions-title">
                        <i class="fas fa-play-circle" style="color: var(--accent-color); margin-left: 0.5rem;"></i>
                        إرشادات التشغيل في Final Cut Pro
                    </h4>
                    
                    <div class="instruction-steps" style="display: grid; gap: 1.5rem;">
                        <div class="step" style="display: flex; align-items: flex-start; gap: 1rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px; border-right: 4px solid var(--accent-color);">
                            <div style="background: var(--accent-color); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">1</div>
                            <div>
                                <h5 style="margin-bottom: 0.5rem; color: var(--text-primary);" id="step1-title">تحضير الملفات</h5>
                                <p style="color: var(--text-secondary); margin: 0;" id="step1-desc">ضع الملف الصوتي المرفوع في مجلد مع ملف XML الذي تم تحميله</p>
                            </div>
                        </div>
                        
                        <div class="step" style="display: flex; align-items: flex-start; gap: 1rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px; border-right: 4px solid var(--accent-color);">
                            <div style="background: var(--accent-color); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">2</div>
                            <div>
                                <h5 style="margin-bottom: 0.5rem; color: var(--text-primary);" id="step2-title">فتح Final Cut Pro</h5>
                                <p style="color: var(--text-secondary); margin: 0;" id="step2-desc">افتح برنامج Final Cut Pro على جهاز Mac</p>
                            </div>
                        </div>
                        
                        <div class="step" style="display: flex; align-items: flex-start; gap: 1rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px; border-right: 4px solid var(--accent-color);">
                            <div style="background: var(--accent-color); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">3</div>
                            <div>
                                <h5 style="margin-bottom: 0.5rem; color: var(--text-primary);" id="step3-title">استيراد المشروع</h5>
                                <p style="color: var(--text-secondary); margin: 0;" id="step3-desc">اسحب ملف XML إلى نافذة Final Cut Pro أو استخدم File > Import > XML</p>
                            </div>
                        </div>
                        
                        <div class="step" style="display: flex; align-items: flex-start; gap: 1rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px; border-right: 4px solid var(--accent-color);">
                            <div style="background: var(--success-color); color: white; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0;">4</div>
                            <div>
                                <h5 style="margin-bottom: 0.5rem; color: var(--text-primary);" id="step4-title">التشغيل والتعديل</h5>
                                <p style="color: var(--text-secondary); margin: 0;" id="step4-desc">ستجد المشروع في مكتبة FCP مع الصوت والترجمة جاهزين للتشغيل والتعديل</p>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.3);">
                        <p style="margin: 0; color: var(--text-secondary); text-align: center; font-size: 0.9rem;" id="note-text">
                            <i class="fas fa-lightbulb" style="color: var(--warning-color); margin-left: 0.5rem;"></i>
                            نصيحة: يمكنك تعديل النصوص والخطوط والمواضع مباشرة في Final Cut Pro بعد الاستيراد
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons animate-fade-up" style="animation-delay: 0.4s;">
            <button class="btn btn-success btn-large" onclick="generateXML()" id="generateProjectBtn" disabled>
                <i class="fas fa-magic"></i> <span id="generate-btn-text">توليد ملف XML</span>
            </button>
            <p style="font-size: 0.9rem; color: var(--text-muted); margin-top: 1rem;" id="settings-link-text">
                يمكنك تخصيص الإعدادات المتقدمة من صفحة <a href="settings.html" style="color: var(--accent-color);" id="settings-link">الإعدادات</a>
            </p>
        </div>
    </div>

    <script>
        let audioFile = null;
        let projectData = {
            audio: null,
            arabicText: '',
            repetitiveText: ''
        };

        // Language system
        const translations = {
            ar: {
                title: 'محول الصوت - FCP Audio to XML',
                logoText: 'محول صوت FCP',
                navHome: 'الرئيسية',
                navConverter: 'المحول',
                navPreview: 'المعاينة',
                navSettings: 'الإعدادات',
                navLibrary: 'مكتبة الفيديو',
                mainTitle: 'محول الصوت إلى XML',
                mainSubtitle: 'ارفع ملف الصوت وأدخل النصوص لإنشاء مشروع Final Cut Pro',
                uploadTitle: 'رفع الملف الصوتي',
                uploadMainText: 'رفع ملف صوتي أو فيديو',
                uploadSupportText: 'يدعم: MP3, WAV, M4A, AAC, FLAC, OGG, MP4, MOV, AVI',
                uploadInstructionText: 'اسحب وأفلت أو اضغط للاختيار',
                libraryBtnText: 'تحميل من مكتبة الفيديو',
                libraryDescription: 'اختر من الفيديوهات المرفوعة مسبقاً',
                textContentTitle: 'محتوى النص',
                arabicTextLabel: 'النص العربي الأساسي:',
                arabicTextPlaceholder: 'أدخل النص العربي هنا...',
                arabicTextDescription: 'النص الرئيسي الذي سيظهر في الترجمة',
                repetitiveTextLabel: 'المستهل (النص المتكرر):',
                repetitiveTextPlaceholder: 'أدخل النص المتكرر هنا...',
                repetitiveTextDescription: 'النص الذي سيتم تكراره في المقطع (مثل: يا حسين، لبيك يا حسين، إلخ)',
                poetryFilterLabel: 'تنقية نصوص القصائد:',
                skipIntrosText: 'تجاهل المستهلات',
                poetryFilterDescription: 'سيتم تجاهل العبارات الافتتاحية والختامية في القصائد',
                generateBtnText: 'توليد ملف XML',
                settingsLinkText: 'يمكنك تخصيص الإعدادات المتقدمة من صفحة',
                settingsLink: 'الإعدادات',
                xmlTitle: 'تم إنشاء ملف XML بنجاح!',
                successTitle: 'ملف Final Cut Pro جاهز للتحميل',
                successDescription: 'سيتم تحميل الملف تلقائياً، أو يمكنك الضغط على زر التحميل أدناه',
                downloadBtnText: 'تحميل ملف XML',
                instructionsTitle: 'إرشادات التشغيل في Final Cut Pro',
                step1Title: 'تحضير الملفات',
                step1Desc: 'ضع الملف الصوتي المرفوع في مجلد مع ملف XML الذي تم تحميله',
                step2Title: 'فتح Final Cut Pro',
                step2Desc: 'افتح برنامج Final Cut Pro على جهاز Mac',
                step3Title: 'استيراد المشروع',
                step3Desc: 'اسحب ملف XML إلى نافذة Final Cut Pro أو استخدم File > Import > XML',
                step4Title: 'التشغيل والتعديل',
                step4Desc: 'ستجد المشروع في مكتبة FCP مع الصوت والترجمة جاهزين للتشغيل والتعديل',
                noteText: 'نصيحة: يمكنك تعديل النصوص والخطوط والمواضع مباشرة في Final Cut Pro بعد الاستيراد',
                // Notifications
                fileUploadSuccess: 'تم تحميل الملف الصوتي بنجاح!',
                invalidFileType: 'يرجى اختيار ملف صوتي أو فيديو',
                noAudioFile: 'يرجى رفع ملف صوتي أولاً',
                noTextContent: 'يرجى إدخال نص عربي أو نص متكرر',
                xmlGenerated: 'تم توليد ملف XML بنجاح!',
                xmlCopied: 'تم نسخ كود XML!',
                xmlCopyFailed: 'فشل في نسخ كود XML',
                xmlDownloaded: 'تم تحميل ملف XML بنجاح!',
                noXmlToDownload: 'لا يوجد كود XML للتحميل',
                libraryComingSoon: 'ميزة مكتبة الفيديو ستكون متاحة قريباً',
                // Audio info
                fileLabel: 'الملف:',
                sizeLabel: 'الحجم:',
                typeLabel: 'النوع:',
                statusLabel: 'الحالة:',
                readyStatus: 'جاهز للتحويل',
                megabytes: 'ميجابايت'
            },
            en: {
                title: 'Audio Converter - FCP Audio to XML',
                logoText: 'FCP Audio Converter',
                navHome: 'Home',
                navConverter: 'Converter',
                navPreview: 'Preview',
                navSettings: 'Settings',
                navLibrary: 'Video Library',
                mainTitle: 'Audio to XML Converter',
                mainSubtitle: 'Upload audio file and enter text to create Final Cut Pro project',
                uploadTitle: 'Upload Audio File',
                uploadMainText: 'Upload Audio or Video File',
                uploadSupportText: 'Supports: MP3, WAV, M4A, AAC, FLAC, OGG, MP4, MOV, AVI',
                uploadInstructionText: 'Drag and drop or click to select',
                libraryBtnText: 'Load from Video Library',
                libraryDescription: 'Choose from previously uploaded videos',
                textContentTitle: 'Text Content',
                arabicTextLabel: 'Main Arabic Text:',
                arabicTextPlaceholder: 'Enter Arabic text here...',
                arabicTextDescription: 'The main text that will appear in the subtitles',
                repetitiveTextLabel: 'Repetitive Text:',
                repetitiveTextPlaceholder: 'Enter repetitive text here...',
                repetitiveTextDescription: 'Text that will be repeated in the clip (e.g., Ya Hussein, Labbaik Ya Hussein, etc.)',
                poetryFilterLabel: 'Poetry Text Filtering:',
                skipIntrosText: 'Skip Introductory Phrases',
                poetryFilterDescription: 'Will ignore introductory and concluding phrases in poems',
                generateBtnText: 'Generate XML File',
                settingsLinkText: 'You can customize advanced settings from the',
                settingsLink: 'Settings',
                xmlTitle: 'XML File Created Successfully!',
                successTitle: 'Final Cut Pro File Ready for Download',
                successDescription: 'The file will download automatically, or you can click the download button below',
                downloadBtnText: 'Download XML File',
                instructionsTitle: 'Instructions for Final Cut Pro',
                step1Title: 'Prepare Files',
                step1Desc: 'Place the uploaded audio file in a folder with the downloaded XML file',
                step2Title: 'Open Final Cut Pro',
                step2Desc: 'Open Final Cut Pro application on your Mac',
                step3Title: 'Import Project',
                step3Desc: 'Drag XML file to Final Cut Pro window or use File > Import > XML',
                step4Title: 'Play and Edit',
                step4Desc: 'You will find the project in FCP library with audio and subtitles ready to play and edit',
                noteText: 'Tip: You can edit texts, fonts, and positions directly in Final Cut Pro after import',
                // Notifications
                fileUploadSuccess: 'Audio file uploaded successfully!',
                invalidFileType: 'Please select an audio or video file',
                noAudioFile: 'Please upload an audio file first',
                noTextContent: 'Please enter Arabic text or repetitive text',
                xmlGenerated: 'XML file generated successfully!',
                xmlCopied: 'XML code copied!',
                xmlCopyFailed: 'Failed to copy XML code',
                xmlDownloaded: 'XML file downloaded successfully!',
                noXmlToDownload: 'No XML code to download',
                libraryComingSoon: 'Video library feature will be available soon',
                // Audio info
                fileLabel: 'File:',
                sizeLabel: 'Size:',
                typeLabel: 'Type:',
                statusLabel: 'Status:',
                readyStatus: 'Ready to convert',
                megabytes: 'MB'
            }
        };

        let currentLanguage = 'ar';

        // Language switching function
        function switchLanguage(lang) {
            if (lang === currentLanguage) return;
            
            currentLanguage = lang;
            const htmlRoot = document.getElementById('html-root');
            const t = translations[lang];
            
            // Add transition effect
            document.body.classList.add('transitioning');
            
            // Update HTML attributes
            htmlRoot.lang = lang;
            htmlRoot.dir = lang === 'ar' ? 'rtl' : 'ltr';
            
            // Update document title
            document.title = t.title;
            
            // Update navigation
            document.getElementById('logo-text').textContent = t.logoText;
            document.getElementById('nav-home').textContent = t.navHome;
            document.getElementById('nav-converter').textContent = t.navConverter;
            document.getElementById('nav-settings').textContent = t.navSettings;
            document.getElementById('nav-library').textContent = t.navLibrary;
            
            // Update main content
            document.getElementById('main-title').textContent = t.mainTitle;
            document.getElementById('main-subtitle').textContent = t.mainSubtitle;
            document.getElementById('upload-title').textContent = t.uploadTitle;
            document.getElementById('upload-main-text').textContent = t.uploadMainText;
            document.getElementById('upload-support-text').textContent = t.uploadSupportText;
            document.getElementById('upload-instruction-text').textContent = t.uploadInstructionText;
            document.getElementById('library-btn-text').textContent = t.libraryBtnText;
            document.getElementById('library-description').textContent = t.libraryDescription;
            document.getElementById('text-content-title').textContent = t.textContentTitle;
            document.getElementById('arabic-text-label').textContent = t.arabicTextLabel;
            document.getElementById('arabic-text-description').textContent = t.arabicTextDescription;
            document.getElementById('repetitive-text-label').textContent = t.repetitiveTextLabel;
            document.getElementById('repetitive-text-description').textContent = t.repetitiveTextDescription;
            document.getElementById('poetry-filter-label').textContent = t.poetryFilterLabel;
            document.getElementById('skip-intros-text').textContent = t.skipIntrosText;
            document.getElementById('poetry-filter-description').textContent = t.poetryFilterDescription;
            document.getElementById('generate-btn-text').textContent = t.generateBtnText;
            document.getElementById('settings-link-text').innerHTML = t.settingsLinkText + ' <a href="settings.html" style="color: var(--accent-color);" id="settings-link">' + t.settingsLink + '</a>';
            
            // Update XML section texts if visible
            const xmlTitleElement = document.getElementById('xml-title');
            const downloadBtnElement = document.getElementById('download-btn-text');
            const successTitleElement = document.getElementById('success-title');
            const successDescElement = document.getElementById('success-description');
            const instructionsTitleElement = document.getElementById('instructions-title');
            const step1TitleElement = document.getElementById('step1-title');
            const step1DescElement = document.getElementById('step1-desc');
            const step2TitleElement = document.getElementById('step2-title');
            const step2DescElement = document.getElementById('step2-desc');
            const step3TitleElement = document.getElementById('step3-title');
            const step3DescElement = document.getElementById('step3-desc');
            const step4TitleElement = document.getElementById('step4-title');
            const step4DescElement = document.getElementById('step4-desc');
            const noteTextElement = document.getElementById('note-text');
            
            if (xmlTitleElement) xmlTitleElement.textContent = t.xmlTitle;
            if (downloadBtnElement) downloadBtnElement.textContent = t.downloadBtnText;
            if (successTitleElement) successTitleElement.textContent = t.successTitle;
            if (successDescElement) successDescElement.textContent = t.successDescription;
            if (instructionsTitleElement) instructionsTitleElement.innerHTML = '<i class="fas fa-play-circle" style="color: var(--accent-color); margin-left: 0.5rem;"></i>' + t.instructionsTitle;
            if (step1TitleElement) step1TitleElement.textContent = t.step1Title;
            if (step1DescElement) step1DescElement.textContent = t.step1Desc;
            if (step2TitleElement) step2TitleElement.textContent = t.step2Title;
            if (step2DescElement) step2DescElement.textContent = t.step2Desc;
            if (step3TitleElement) step3TitleElement.textContent = t.step3Title;
            if (step3DescElement) step3DescElement.textContent = t.step3Desc;
            if (step4TitleElement) step4TitleElement.textContent = t.step4Title;
            if (step4DescElement) step4DescElement.textContent = t.step4Desc;
            if (noteTextElement) noteTextElement.innerHTML = '<i class="fas fa-lightbulb" style="color: var(--warning-color); margin-left: 0.5rem;"></i>' + t.noteText;
            
            // Update placeholders
            document.getElementById('arabicText').placeholder = t.arabicTextPlaceholder;
            document.getElementById('repetitiveText').placeholder = t.repetitiveTextPlaceholder;
            
            // Update text direction for input fields
            const arabicTextArea = document.getElementById('arabicText');
            const repetitiveTextArea = document.getElementById('repetitiveText');
            
            if (lang === 'ar') {
                arabicTextArea.style.direction = 'rtl';
                arabicTextArea.style.textAlign = 'right';
                repetitiveTextArea.style.direction = 'rtl';
                repetitiveTextArea.style.textAlign = 'right';
            } else {
                arabicTextArea.style.direction = 'ltr';
                arabicTextArea.style.textAlign = 'left';
                repetitiveTextArea.style.direction = 'ltr';
                repetitiveTextArea.style.textAlign = 'left';
            }
            
            // Update language toggle buttons
            document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(lang === 'ar' ? 'btn-arabic' : 'btn-english').classList.add('active');
            
            // Save language preference
            localStorage.setItem('preferredLanguage', lang);
            
            // Remove transition effect
            setTimeout(() => {
                document.body.classList.remove('transitioning');
            }, 500);
        }

        // Enhanced notification system with language support
        function showNotification(messageKey, type = 'success') {
            const message = translations[currentLanguage][messageKey] || messageKey;
            const notification = document.createElement('div');
            notification.className = `notification ${type} show`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Drag and drop functionality
        const uploadZone = document.querySelector('.upload-zone');
        
        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleAudioFile(files[0]);
            }
        });

        // Audio upload handling with enhanced UX
        function handleAudioUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            handleAudioFile(file);
        }

        function handleAudioFile(file) {
            // Check if file is audio or video
            const validTypes = ['audio/', 'video/'];
            if (!validTypes.some(type => file.type.startsWith(type))) {
                showNotification('invalidFileType', 'error');
                return;
            }

            // Add loading state
            const generateBtn = document.getElementById('generateProjectBtn');
            generateBtn.classList.add('loading');

            audioFile = file;
            projectData.audio = file;

            // Create URL for preview
            const audioURL = URL.createObjectURL(file);
            
            // Show audio preview
            const audioPreview = document.getElementById('audioPreview');
            const audioPlayer = document.getElementById('audioPlayer');
            const audioInfo = document.getElementById('audioInfo');
            
            audioPlayer.src = audioURL;
            
            const t = translations[currentLanguage];
            audioInfo.innerHTML = `
                <strong>${t.fileLabel}</strong> ${file.name}<br>
                <strong>${t.sizeLabel}</strong> ${(file.size / (1024 * 1024)).toFixed(2)} ${t.megabytes}<br>
                <strong>${t.typeLabel}</strong> ${file.type}<br>
                <strong>${t.statusLabel}</strong> <span style="color: var(--success-color);">${t.readyStatus}</span>
            `;
            
            audioPreview.style.display = 'block';
            
            // Remove loading state and enable generate button
            setTimeout(() => {
                generateBtn.classList.remove('loading');
                generateBtn.disabled = false;
            }, 500);
            
            showNotification('fileUploadSuccess', 'success');
        }

        // Load from video library
        function loadFromVideoLibrary() {
            showNotification('libraryComingSoon', 'warning');
        }

        // Generate Final Cut Pro XML with enhanced UX
        let generatedXML = '';

        // Text processing function to handle poetry intro filtering
        function processPoetryText(text, settings) {
            if (!text || !settings.skipPoetryIntros) {
                return text;
            }

            // Split text into lines for processing
            let lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            
            // Default patterns to skip
            const skipPatterns = [
                ...(settings.poetryIntroPatterns || []),
                ...(settings.customSkipPatterns || [])
            ];

            // Function to check if a line should be skipped
            function shouldSkipLine(line) {
                return skipPatterns.some(pattern => {
                    return line.includes(pattern) || 
                           line.startsWith(pattern) || 
                           line.endsWith(pattern);
                });
            }

            // Filter beginning intros if enabled
            if (settings.skipBeginningIntros) {
                while (lines.length > 0 && shouldSkipLine(lines[0])) {
                    lines.shift();
                }
            }

            // Filter ending intros if enabled  
            if (settings.skipEndingIntros) {
                while (lines.length > 0 && shouldSkipLine(lines[lines.length - 1])) {
                    lines.pop();
                }
            }

            // Return processed text
            return lines.join('\n');
        }

        // Generate Final Cut Pro XML with enhanced UX
        function generateXML() {
            const arabicTextRaw = document.getElementById('arabicText').value.trim();
            const repetitiveTextRaw = document.getElementById('repetitiveText').value.trim();
            if (!audioFile) return showNotification('noAudioFile', 'error');
            if (!arabicTextRaw && !repetitiveTextRaw) return showNotification('noTextContent', 'error');

            const settings = loadSettings();
            settings.skipPoetryIntros = document.getElementById('skipPoetryIntros') ? document.getElementById('skipPoetryIntros').checked : false;
            const arabicText = processPoetryText(arabicTextRaw, settings);
            const repetitiveText = processPoetryText(repetitiveTextRaw, settings);

            const globalSettings = typeof getConverterSettings !== 'undefined' ? getConverterSettings() : {};
            const arabicFont = globalSettings.arabicFont || 'Arial';
            const arabicFontSize = globalSettings.arabicFontSize || 34;
            const arabicPositionY = globalSettings.arabicPositionY || -381;
            const englishFont = globalSettings.englishFont || 'Helvetica';
            const englishFontSize = globalSettings.englishFontSize || 25;
            const englishPositionY = globalSettings.englishPositionY || -420;
            const resolution = globalSettings.previewResolution || '1920x1080';
            const frameRate = 25;
            const [width, height] = resolution.split('x').map(Number);
            const duration = settings.duration || 5;
            const startTime = settings.startTime || 0;
            const totalFrames = Math.ceil(duration * frameRate);
            const startFrames = Math.floor(startTime * frameRate);
            const displayMode = settings.displayMode || 'arabic';
            const uid = generateUID();
            const date = new Date().toISOString();
            const escape = escapeXML;
            const audioName = escape(audioFile.name);

            // تحويل القيم الزمنية إلى صيغة الفريمات/معدل الفريم (frames/frameRate)s
            function toFrameTime(frames, frameRate) {
                return `${frames}/${frameRate}s`;
            }

            // uid ثابت للأصول
            const assetUID = generateUID();
            // uid ثابت للمشروع
            const projectUID = uid;

            // توليد عناصر التايتل بشكل قياسي مع ربط text-style-def
            const addTitle = (text, styleId, posY, refName, offsetFrames, durationFrames) => {
                return `              <title ref="e1" name="${refName}" lane="1" role="title" enabled="1" offset="${toFrameTime(offsetFrames, frameRate)}" duration="${toFrameTime(durationFrames, frameRate)}">
                <param name="Position" key="9999/999166631/999166633/1/100/101" value="0 ${posY}"/>
                <param name="Alignment" key="9999/999166631/999166633/2/351" value="1 (Center)"/>
                <text>
                  <text-style ref="${styleId}">${escape(text)}</text-style>
                </text>
              </title>`;
            };

            let xml = `<?xml version="1.0" encoding="UTF-8"?>
<fcpxml version="1.10">
  <resources>
    <format id="r1" name="FFVideoFormat${height}p${frameRate}" frameDuration="1/${frameRate}s" width="${width}" height="${height}" colorSpace="1-1-1 (Rec. 709)"/>
    <effect id="e1" name="Basic Title" uid="/Titles.localized/Bumper:Opener.localized/Basic Title.localized/Basic Title.moti"/>
    <asset id="a1" name="${audioName}" uid="${assetUID}" start="0s" duration="${toFrameTime(totalFrames, frameRate)}" hasVideo="0" hasAudio="1">
      <media-rep kind="original-media" src="file:///${audioName}"/>
    </asset>
    <text-style-def id="tsd1" font="${arabicFont}" fontSize="${arabicFontSize}" fontFace="Regular" fontColor="1 1 1 1" alignment="center"/>
    <text-style-def id="tsd2" font="${englishFont}" fontSize="${englishFontSize}" fontFace="Regular" fontColor="1 1 1 1" alignment="center"/>
  </resources>
  <library location="file:///Users/user/Movies/">
    <event name="Subtitle Project ${new Date().toLocaleDateString()}">
      <project name="Arabic English Subtitles" uid="${projectUID}" modDate="${date}">
        <sequence format="r1" duration="${toFrameTime(totalFrames, frameRate)}" tcStart="0s" tcFormat="NDF" audioLayout="stereo" audioRate="48k">
          <spine>
            <asset-clip name="${audioName}" ref="a1" offset="0s" duration="${toFrameTime(totalFrames, frameRate)}" tcFormat="NDF" audioRole="dialogue"/>
            <gap name="Gap" offset="${toFrameTime(0, frameRate)}" duration="${toFrameTime(totalFrames, frameRate)}">
`;

            if (displayMode === 'arabic' || displayMode === 'both') {
                xml += addTitle(arabicText, 'tsd1', arabicPositionY, 'Arabic Text', startFrames, totalFrames - startFrames);
            }
            if (displayMode === 'repetitive' || displayMode === 'both') {
                xml += addTitle(repetitiveText, 'tsd2', englishPositionY, 'English Text', startFrames, totalFrames - startFrames);
            }
            if (displayMode === 'alternating') {
                const half = Math.floor((totalFrames - startFrames) / 2);
                xml += addTitle(arabicText, 'tsd1', arabicPositionY, 'Arabic Text', startFrames, half);
                xml += addTitle(repetitiveText, 'tsd2', englishPositionY, 'English Text', startFrames + half, totalFrames - startFrames - half);
            }

            xml += `
            </gap>
          </spine>
        </sequence>
      </project>
    </event>
  </library>
</fcpxml>`;

            generatedXML = xml;
            
            // Download XML file
            const blob = new Blob([xml], { type: 'application/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${audioName.replace(/\.[^/.]+$/, '') || 'project'}.fcpxml`;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
            
            document.getElementById('xmlSection').style.display = 'block';
            showNotification('xmlGenerated', 'success');
        }

        // Download XML file
        function downloadXML() {
            if (!generatedXML) {
                showNotification('noXmlToDownload', 'error');
                return;
            }
            
            const blob = new Blob([generatedXML], { type: 'application/xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${audioFile ? audioFile.name.replace(/\.[^/.]+$/, '') : 'project'}.fcpxml`;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);
            
            showNotification('xmlDownloaded', 'success');
        }

        // Load settings function
        function loadSettings() {
            const defaultSettings = {
                duration: 5,
                startTime: 0,
                displayMode: 'arabic',
                skipPoetryIntros: true,
                poetryIntroPatterns: ['مستهل', 'يا حسين', 'لبيك يا حسين', 'السلام عليك', 'صلى الله عليه وآله'],
                skipBeginningIntros: true,
                skipEndingIntros: true,
                customSkipPatterns: []
            };
            
            try {
                const saved = localStorage.getItem('converterSettings');
                return saved ? { ...defaultSettings, ...JSON.parse(saved) } : defaultSettings;
            } catch {
                return defaultSettings;
            }
        }

        // Generate UID function
        function generateUID() {
            return 'xxxx-xxxx-4xxx-yxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Escape XML function
        function escapeXML(text) {
            if (!text) return '';
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // Notification system
        function showNotification(messageKey, type = 'success') {
            const t = translations[currentLanguage];
            const messages = {
                poetryFilterEnabled: {
                    ar: 'تم تفعيل تنقية نصوص القصائد - سيتم تجاهل المستهلات',
                    en: 'Poetry text filtering enabled - introductory phrases will be ignored'
                },
                poetryFilterDisabled: {
                    ar: 'تم إلغاء تنقية نصوص القصائد - سيتم إدراج جميع النصوص',
                    en: 'Poetry text filtering disabled - all text will be included'
                },
                noAudioFile: {
                    ar: 'يرجى رفع ملف صوتي أولاً',
                    en: 'Please upload an audio file first'
                },
                noTextContent: {
                    ar: 'يرجى إدخال النص العربي أو النص المتكرر',
                    en: 'Please enter Arabic text or repetitive text'
                },
                xmlGenerated: {
                    ar: 'تم توليد ملف XML بنجاح!',
                    en: 'XML file generated successfully!'
                },
                xmlCopied: {
                    ar: 'تم نسخ XML إلى الحافظة',
                    en: 'XML copied to clipboard'
                },
                xmlDownloaded: {
                    ar: 'تم تحميل ملف XML',
                    en: 'XML file downloaded'
                },
                fileUploadSuccess: {
                    ar: 'تم رفع الملف بنجاح',
                    en: 'File uploaded successfully'
                }
            };
            
            const message = messages[messageKey] ? messages[messageKey][currentLanguage] : messageKey;
            
            const notification = document.createElement('div');
            notification.className = `notification ${type} show`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Initialize on page load with enhanced features
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved language preference
            const savedLanguage = localStorage.getItem('preferredLanguage') || 'ar';
            if (savedLanguage !== 'ar') {
                switchLanguage(savedLanguage);
            }
            
            // Load saved text content
            const savedArabic = localStorage.getItem('savedArabicText');
            const savedRepetitive = localStorage.getItem('savedRepetitiveText');
            
            if (savedArabic) {
                document.getElementById('arabicText').value = savedArabic;
            }
            
            if (savedRepetitive) {
                document.getElementById('repetitiveText').value = savedRepetitive;
            }
            
            // Auto-save text content with debouncing
            let saveTimeout;
            
            function autoSave(key, value) {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(() => {
                    localStorage.setItem(key, value);
                }, 500);
            }
            
            document.getElementById('arabicText').addEventListener('input', function() {
                autoSave('savedArabicText', this.value);
            });
            
            document.getElementById('repetitiveText').addEventListener('input', function() {
                autoSave('savedRepetitiveText', this.value);
            });
            
            // Handle poetry filtering checkbox
            document.getElementById('skipPoetryIntros').addEventListener('change', function() {
                localStorage.setItem('skipPoetryIntros', this.checked);
                
                // Show preview of filtering effect
                if (this.checked) {
                    showNotification('poetryFilterEnabled', 'info');
                } else {
                    showNotification('poetryFilterDisabled', 'warning');
                }
            });
            
            // Load saved poetry filter setting
            const savedSkipIntros = localStorage.getItem('skipPoetryIntros');
            if (savedSkipIntros !== null) {
                document.getElementById('skipPoetryIntros').checked = savedSkipIntros === 'true';
            }
            
            // Add smooth scroll behavior
            document.documentElement.style.scrollBehavior = 'smooth';
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                // Ctrl/Cmd + L to switch language
                if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
                    e.preventDefault();
                    switchLanguage(currentLanguage === 'ar' ? 'en' : 'ar');
                }
                
                // Ctrl/Cmd + Enter to generate XML
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    const generateBtn = document.getElementById('generateProjectBtn');
                    if (!generateBtn.disabled) {
                        generateXML();
                    }
                }
            });
        });
    </script>
</body>
</html>
